<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Threat Intel Results - {{ ip_address }}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/threat_intel.css') }}">
</head>

<body>
    <div class="container">
        <header>
            <h1>âš¡ THREAT INTEL RESULTS âš¡</h1>
            <p>Analysis for: <strong style="color: var(--accent-cyan);">{{ ip_address }}</strong></p>
        </header>

        <main>
            {% if from_cache %}
            <div class="alert alert-info">
                â„¹ï¸ Results loaded from cache | Expires in: {{ cache_expires }}
            </div>
            {% endif %}

            <!-- Risk Score Card with Visual Gauge -->
            <div class="card" style="text-align: center;">
                <h2>Overall Risk Assessment</h2>
                {% set risk_score = threat_data.risk_score | default(0) %}
                {% set confidence_score = threat_data.confidence_score | default(0) %}

                <!-- Circular Risk Gauge -->
                <div style="position: relative; width: 200px; height: 200px; margin: 20px auto;">
                    <svg width="200" height="200" viewBox="0 0 200 200">
                        <!-- Background circle -->
                        <circle cx="100" cy="100" r="80" fill="none" stroke="rgba(255,255,255,0.1)" stroke-width="20"/>

                        <!-- Progress circle -->
                        {% if risk_score < 25 %}
                            {% set stroke_color = "#00ff00" %}
                        {% elif risk_score < 75 %}
                            {% set stroke_color = "#ffa500" %}
                        {% else %}
                            {% set stroke_color = "#ff0000" %}
                        {% endif %}
                        <circle cx="100" cy="100" r="80" fill="none"
                                stroke="{{ stroke_color }}" stroke-width="20"
                                stroke-dasharray="{{ (risk_score / 100 * 502) }} 502"
                                stroke-dashoffset="125.5"
                                transform="rotate(-90 100 100)"
                                style="transition: stroke-dasharray 1s ease;"/>

                        <!-- Center text -->
                        <text x="100" y="95" text-anchor="middle" font-size="36" font-weight="bold" fill="{{ stroke_color }}">
                            {{ risk_score }}
                        </text>
                        <text x="100" y="115" text-anchor="middle" font-size="14" fill="var(--text-secondary)">
                            / 100
                        </text>
                    </svg>
                </div>

                {% if risk_score < 25 %}
                    <p style="color: var(--safe-green); margin-top: 15px; font-size: 1.2em;">âœ… LOW RISK</p>
                {% elif risk_score < 75 %}
                    <p style="color: var(--warning-orange); margin-top: 15px; font-size: 1.2em;">âš ï¸ MEDIUM RISK</p>
                {% else %}
                    <p style="color: var(--danger-red); margin-top: 15px; font-size: 1.2em;">ğŸš¨ HIGH RISK</p>
                {% endif %}

                <!-- Confidence Score with Progress Bar -->
                <div style="margin-top: 20px; padding: 15px; background: rgba(0, 255, 255, 0.1); border-radius: 8px;">
                    <p style="color: var(--text-secondary); margin-bottom: 10px;">Confidence Level</p>

                    <!-- Progress bar -->
                    <div style="background: rgba(0,0,0,0.3); border-radius: 10px; height: 20px; overflow: hidden; margin-bottom: 10px;">
                        {% if confidence_score >= 80 %}
                            {% set conf_color = "#00ff00" %}
                        {% elif confidence_score >= 60 %}
                            {% set conf_color = "#00ffff" %}
                        {% elif confidence_score >= 40 %}
                            {% set conf_color = "#ffa500" %}
                        {% else %}
                            {% set conf_color = "#ff0000" %}
                        {% endif %}
                        <div style="width: {{ confidence_score }}%; height: 100%; background: linear-gradient(90deg, {{ conf_color }}, {{ conf_color }}88); transition: width 1s ease;"></div>
                    </div>

                    {% if confidence_score >= 80 %}
                        <p style="color: var(--safe-green); font-size: 1.1em; font-weight: bold;">ğŸ¯ {{ confidence_score }}% - VERY HIGH</p>
                    {% elif confidence_score >= 60 %}
                        <p style="color: var(--accent-cyan); font-size: 1.1em; font-weight: bold;">âœ“ {{ confidence_score }}% - HIGH</p>
                    {% elif confidence_score >= 40 %}
                        <p style="color: var(--warning-orange); font-size: 1.1em; font-weight: bold;">â— {{ confidence_score }}% - MEDIUM</p>
                    {% else %}
                        <p style="color: var(--danger-red); font-size: 1.1em; font-weight: bold;">âš  {{ confidence_score }}% - LOW</p>
                    {% endif %}
                </div>

    <p style="color: var(--text-secondary); margin-top: 10px;">
        {% if threat_data.is_malicious %}
        This IP has been flagged as potentially malicious
        {% else %}
        No significant malicious activity detected
        {% endif %}
    </p>
    </div>

    <!-- Recommendation Card -->
    {% if threat_data.recommendation %}
    <div class="card">
        <h2>ğŸ›¡ï¸ Security Recommendation</h2>
        {% set rec = threat_data.recommendation %}
        {% set action = rec.action | default('INVESTIGATE') %}
        {% set priority = rec.priority | default('MEDIUM') %}

        <div style="display: flex; gap: 20px; flex-wrap: wrap; margin-bottom: 20px;">
            <!-- Action Badge -->
            <div style="flex: 1; min-width: 150px; text-align: center; padding: 20px; border-radius: 8px;
                        {% if action == 'BLOCK' %}background: rgba(255, 0, 0, 0.2); border: 2px solid var(--danger-red);
                        {% elif action == 'MONITOR' %}background: rgba(255, 165, 0, 0.2); border: 2px solid var(--warning-orange);
                        {% elif action == 'INVESTIGATE' %}background: rgba(0, 255, 255, 0.2); border: 2px solid var(--accent-cyan);
                        {% else %}background: rgba(0, 255, 0, 0.2); border: 2px solid var(--safe-green);{% endif %}">
                <p style="color: var(--text-secondary); margin-bottom: 5px;">Recommended Action</p>
                <p style="font-size: 1.5em; font-weight: bold;
                            {% if action == 'BLOCK' %}color: var(--danger-red);
                            {% elif action == 'MONITOR' %}color: var(--warning-orange);
                            {% elif action == 'INVESTIGATE' %}color: var(--accent-cyan);
                            {% else %}color: var(--safe-green);{% endif %}">
                    {% if action == 'BLOCK' %}ğŸš«{% elif action == 'MONITOR' %}ğŸ‘ï¸{% elif action == 'INVESTIGATE' %}ğŸ”{%
                    else %}âœ…{% endif %}
                    {{ action }}
                </p>
            </div>

            <!-- Priority Badge -->
            <div style="flex: 1; min-width: 150px; text-align: center; padding: 20px; border-radius: 8px;
                        {% if priority == 'CRITICAL' %}background: rgba(255, 0, 0, 0.2); border: 2px solid var(--danger-red);
                        {% elif priority == 'HIGH' %}background: rgba(255, 165, 0, 0.2); border: 2px solid var(--warning-orange);
                        {% elif priority == 'MEDIUM' %}background: rgba(0, 255, 255, 0.2); border: 2px solid var(--accent-cyan);
                        {% else %}background: rgba(0, 255, 0, 0.2); border: 2px solid var(--safe-green);{% endif %}">
                <p style="color: var(--text-secondary); margin-bottom: 5px;">Priority Level</p>
                <p style="font-size: 1.5em; font-weight: bold;
                            {% if priority == 'CRITICAL' %}color: var(--danger-red);
                            {% elif priority == 'HIGH' %}color: var(--warning-orange);
                            {% elif priority == 'MEDIUM' %}color: var(--accent-cyan);
                            {% else %}color: var(--safe-green);{% endif %}">
                    {% if priority == 'CRITICAL' %}ğŸ”´{% elif priority == 'HIGH' %}ğŸŸ {% elif priority == 'MEDIUM' %}ğŸ”µ{%
                    else %}ğŸŸ¢{% endif %}
                    {{ priority }}
                </p>
            </div>
        </div>

        <!-- Justification -->
        <div
            style="background: rgba(255, 255, 255, 0.05); padding: 15px; border-radius: 8px; border-left: 4px solid var(--accent-cyan);">
            <p style="color: var(--text-secondary); margin-bottom: 5px;">ğŸ“‹ Justification:</p>
            <p style="color: var(--text-primary);">{{ rec.justification | default('Assessment based on available threat
                intelligence data.') }}</p>
        </div>

        {% if rec.confidence_note %}
        <p style="color: var(--text-secondary); margin-top: 10px; font-style: italic;">
            ğŸ’¡ {{ rec.confidence_note }}
        </p>
        {% endif %}
    </div>
    {% endif %}

    <!-- Details Grid -->
    <div class="results-grid">
        <!-- Location Info -->
        <div class="info-box">
            <h3>ğŸ“ Location</h3>
            <p>Country:</p>
            <p class="value">{{ threat_data.country or 'Unknown' }}</p>
            {% if threat_data.country_code %}
            <p style="margin-top: 10px;">Code: <span class="value">{{ threat_data.country_code }}</span></p>
            {% endif %}
        </div>

        <!-- ISP Info -->
        <div class="info-box">
            <h3>ğŸŒ Network</h3>
            <p>ISP:</p>
            <p class="value">{{ threat_data.isp or 'Unknown' }}</p>
            {% if threat_data.domain %}
            <p style="margin-top: 10px;">Domain: <span class="value">{{ threat_data.domain }}</span></p>
            {% endif %}
        </div>

        <!-- Reports Info -->
        <div class="info-box">
            <h3>ğŸ“Š Reports</h3>
            <p>Total Reports:</p>
            <p class="value">{{ threat_data.total_reports | default(0) }}</p>
            {% if threat_data.last_reported %}
            <p style="margin-top: 10px;">Last Reported: {{ threat_data.last_reported }}</p>
            {% endif %}
        </div>

        <!-- Sources Info -->
        <div class="info-box">
            <h3>ğŸ” Data Sources</h3>
            <p>Sources Used:</p>
            <p class="value">{{ threat_data.sources | length }}</p>
            <div class="tags">
                {% for source in threat_data.sources %}
                <span class="tag">{{ source }}</span>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Source Health Dashboard -->
    <div class="card">
        <h2>ğŸ“¡ API Source Health</h2>
        <p style="color: var(--text-secondary); margin-bottom: 20px;">Status of threat intelligence data providers</p>

        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
            {% set all_sources = ['AbuseIPDB', 'AlienVault OTX', 'VirusTotal', 'GreyNoise'] %}
            {% for api_source in all_sources %}
                <div style="background: rgba(255, 255, 255, 0.05); padding: 15px; border-radius: 8px; border-left: 4px solid {{ '#00ff00' if api_source in threat_data.sources else '#ff0000' }};">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px;">
                        <span style="font-weight: bold;">{{ api_source }}</span>
                        {% if api_source in threat_data.sources %}
                            <span style="color: #00ff00; font-size: 1.2em;">âœ“</span>
                        {% else %}
                            <span style="color: #ff0000; font-size: 1.2em;">âœ—</span>
                        {% endif %}
                    </div>
                    <div style="font-size: 0.9em; color: var(--text-secondary);">
                        {% if api_source in threat_data.sources %}
                            <span style="color: #00ff00;">â— Online</span>
                        {% else %}
                            <span style="color: #888;">â— No Response</span>
                        {% endif %}
                    </div>
                </div>
            {% endfor %}
        </div>

        <div style="margin-top: 15px; padding: 10px; background: rgba(0, 255, 255, 0.1); border-radius: 5px; text-align: center;">
            <span style="color: var(--accent-cyan); font-weight: bold;">
                {{ threat_data.sources | length }}/4 sources responded
            </span>
            {% if threat_data.sources | length == 4 %}
                <span style="margin-left: 10px; color: #00ff00;">ğŸ¯ Full Coverage</span>
            {% elif threat_data.sources | length >= 3 %}
                <span style="margin-left: 10px; color: #ffa500;">âš  Good Coverage</span>
            {% else %}
                <span style="margin-left: 10px; color: #ff0000;">âš  Limited Data</span>
            {% endif %}
        </div>
    </div>

    <!-- Threat Categories -->
    {% if threat_data.categories or threat_data.threat_types %}
    <div class="card">
        <h2>ğŸ¯ Threat Categories</h2>

        {% if threat_data.categories %}
        <div style="margin-bottom: 20px;">
            <p style="color: var(--text-secondary); margin-bottom: 10px;">Abuse Categories:</p>
            <div class="tags">
                {% for category in threat_data.categories %}
                <span class="tag">{{ category }}</span>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        {% if threat_data.threat_types %}
        <div>
            <p style="color: var(--text-secondary); margin-bottom: 10px;">Threat Types:</p>
            <div class="tags">
                {% for threat_type in threat_data.threat_types %}
                <span class="tag">{{ threat_type }}</span>
                {% endfor %}
            </div>
        </div>
        {% endif %}
    </div>
    {% endif %}

    <!-- CTIA Framework Section -->
    <div class="card">
        <h2>ğŸ”¬ Cyber Threat Intelligence Analysis (CTIA)</h2>

        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">

            <!-- MITRE ATT&CK Section -->
            <div
                style="background: rgba(255, 255, 255, 0.05); padding: 20px; border-radius: 8px; border: 1px solid rgba(0, 255, 255, 0.3);">
                <h3 style="color: var(--accent-cyan); margin-bottom: 15px;">
                    âš”ï¸ MITRE ATT&CK Techniques
                </h3>
                {% if threat_data.mitre_attack and threat_data.mitre_attack | length > 0 %}
                <p style="color: var(--text-secondary); margin-bottom: 10px;">
                    {{ threat_data.mitre_attack | length }} technique(s) identified:
                </p>
                <div style="max-height: 250px; overflow-y: auto;">
                    {% for technique in threat_data.mitre_attack %}
                    <div
                        style="background: rgba(0, 0, 0, 0.3); padding: 10px; margin-bottom: 8px; border-radius: 5px; border-left: 3px solid var(--accent-cyan);">
                        <a href="https://attack.mitre.org/techniques/{{ technique.id.replace('.', '/') }}/"
                            target="_blank"
                            style="color: var(--accent-cyan); text-decoration: none; font-weight: bold;">
                            {{ technique.id }}
                        </a>
                        <span style="color: var(--text-primary);">- {{ technique.name }}</span>
                        <br>
                        <small style="color: var(--text-secondary);">Tactic: {{ technique.tactic }}</small>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <p style="color: var(--text-secondary);">
                    No specific ATT&CK techniques mapped for this indicator.
                </p>
                {% endif %}
            </div>

            <!-- Kill Chain Section -->
            <div
                style="background: rgba(255, 255, 255, 0.05); padding: 20px; border-radius: 8px; border: 1px solid rgba(255, 165, 0, 0.3);">
                <h3 style="color: var(--warning-orange); margin-bottom: 15px;">
                    ğŸ”— Cyber Kill Chain Stages
                </h3>
                {% if threat_data.kill_chain_stages and threat_data.kill_chain_stages | length > 0 %}

                <!-- Progress Indicator -->
                <div style="margin-bottom: 15px; padding: 10px; background: rgba(255, 165, 0, 0.1); border-radius: 5px; text-align: center;">
                    <div style="color: var(--warning-orange); font-weight: bold; margin-bottom: 5px;">
                        {{ threat_data.kill_chain_stages | length }}/7 Stages Detected
                    </div>
                    <div style="background: rgba(0,0,0,0.3); height: 10px; border-radius: 5px; overflow: hidden;">
                        <div style="width: {{ (threat_data.kill_chain_stages | length / 7 * 100) }}%; height: 100%; background: linear-gradient(90deg, #ffa500, #ff6600);"></div>
                    </div>
                </div>

                <p style="color: var(--text-secondary); margin-bottom: 10px;">
                    Attack spans {{ threat_data.kill_chain_stages | length }} stage(s):
                </p>

                <!-- Kill Chain Visual -->
                <div style="display: flex; flex-direction: column; gap: 8px;">
                    {% set all_stages = ['1. Reconnaissance', '2. Weaponization', '3. Delivery', '4. Exploitation', '5.
                    Installation', '6. Command & Control', '7. Actions on Objectives'] %}
                    {% for stage in all_stages %}
                    {% if stage in threat_data.kill_chain_stages %}
                    <div
                        style="background: rgba(255, 165, 0, 0.3); padding: 10px; border-radius: 5px; border-left: 3px solid var(--warning-orange);">
                        <span style="color: var(--warning-orange); font-weight: bold;">â—</span>
                        <span style="color: var(--text-primary);">{{ stage }}</span>
                    </div>
                    {% else %}
                    <div
                        style="background: rgba(255, 255, 255, 0.02); padding: 10px; border-radius: 5px; border-left: 3px solid rgba(255, 255, 255, 0.1);">
                        <span style="color: var(--text-secondary);">â—‹ {{ stage }}</span>
                    </div>
                    {% endif %}
                    {% endfor %}
                </div>
                {% else %}
                <p style="color: var(--text-secondary);">
                    No Kill Chain stages identified for this indicator.
                </p>
                {% endif %}
            </div>
        </div>

        <p style="color: var(--text-secondary); margin-top: 15px; font-size: 0.9em; text-align: center;">
            ğŸ“š Framework references:
            <a href="https://attack.mitre.org/" target="_blank" style="color: var(--accent-cyan);">MITRE ATT&CK</a> |
            <a href="https://www.lockheedmartin.com/en-us/capabilities/cyber/cyber-kill-chain.html" target="_blank"
                style="color: var(--warning-orange);">Lockheed Martin Kill Chain</a>
        </p>
    </div>

    <!-- Export Actions -->
    <div class="card" style="text-align: center; margin-top: 30px;">
        <h2>ğŸ“¥ Export Results</h2>
        <p style="color: var(--text-secondary); margin-bottom: 20px;">Download threat intelligence data in multiple
            formats</p>
        <div style="display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;">
            <a href="{{ url_for('threat_intel.export_json', ip=ip_address) }}" class="btn" style="min-width: 120px;">
                ğŸ“„ JSON
            </a>
            <a href="{{ url_for('threat_intel.export_csv', ip=ip_address) }}" class="btn" style="min-width: 120px;">
                ğŸ“Š CSV
            </a>
            <a href="{{ url_for('threat_intel.export_pdf', ip=ip_address) }}" class="btn" style="min-width: 120px;">
                ğŸ“‘ PDF Report
            </a>
        </div>
    </div>

    <!-- Actions -->
    <div style="text-align: center; margin-top: 40px;">
        <a href="{{ url_for('threat_intel.index') }}" class="btn">ğŸ” Analyze Another IP</a>
    </div>
    </main>

    <footer>
        <p>&copy; 2024 Threat Intel Lookup | Built with Python & Flask</p>
    </footer>
    </div>
</body>

</html>